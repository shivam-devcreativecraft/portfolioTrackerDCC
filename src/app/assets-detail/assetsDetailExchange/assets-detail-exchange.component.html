<ng-container *ngIf="!IsExchangeDataLoaded">
    <div class="loader-div d-flex justify-content-center align-items-center flex-column h-100">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <span class="pt-2">Loading ...</span>
</div>
</ng-container>

    <!-- Custom Navigation -->
    <!-- <div class="custom-nav">
        <button mat-raised-button 
            [class.active]="activeSection === 'analytics'"
            (click)="setActiveSection('analytics')"
            class="nav-button">
            <mat-icon>analytics</mat-icon>
            <span>Analytics</span>
        </button>
        <button mat-raised-button 
            [class.active]="activeSection === 'exchange-assets'"
            (click)="setActiveSection('exchange-assets')"
            class="nav-button">
            <mat-icon>account_balance</mat-icon>
            <span>Exchange Assets</span>
        </button>
    </div> -->

    <!-- Analytics Section -->
    <ng-container *ngIf="IsExchangeDataLoaded">

    <div class="analytics-section">
        <div class="container-fluid">
            <div class="row g-4">
                <!-- Search Field -->
                <div class="col-12">
                    <mat-form-field appearance="outline" class="w-100" floatLabel="always">
                        <mat-label>Search Coin</mat-label>
                        <input matInput 
                               [(ngModel)]="analyticsSearchTerm" 
                               (ngModelChange)="filterCoins(); filterAnalyticsData()"
                               [matAutocomplete]="auto"
                               placeholder="Search by coin (BTC, ETH...)">
                        <button class="text-danger" 
                                *ngIf="analyticsSearchTerm || selectedCoin" 
                                matSuffix 
                                mat-icon-button 
                                aria-label="Clear" 
                                (click)="clearAnalyticsSearch()">
                            <mat-icon>close</mat-icon>
                        </button>
                        <mat-autocomplete #auto="matAutocomplete">
                            <mat-option *ngFor="let coin of filteredCoins" [value]="coin">
                                <div class="coin-option">
                                    <span class="coin-name">{{coin}}</span>
                                    <span class="exchange-count" *ngIf="getCoinAnalytics(coin).exchanges.length > 0">
                                        (Present in {{getCoinAnalytics(coin).exchanges.length}} 
                                        {{getCoinAnalytics(coin).exchanges.length === 1 ? 'exchange' : 'exchanges'}})
                                    </span>
                                </div>
                            </mat-option>
                        </mat-autocomplete>
                    </mat-form-field>
                </div>

                <!-- Portfolio Overview Card -->
                <div class="col-12">
                    <div class="portfolio-overview">
                        <div class="row g-0">
                            <!-- Total Value Section -->
                            <div class="col-12 col-lg-4 value-section">
                                <div class="total-value">
                                    <div class="value-label">
                                        <ng-container *ngIf="!selectedCoin">Total Portfolio Value</ng-container>
                                        <ng-container *ngIf="selectedCoin">{{ selectedCoin }} Total Value</ng-container>
                                    </div>
                                    <div class="value-amount">
                                        <span class="currency">$</span>
                                        <span class="amount">
                                            <ng-container *ngIf="!selectedCoin">
                                                {{ getTotalPortfolioValue() | number:'1.2-2' }}
                                            </ng-container>
                                            <ng-container *ngIf="selectedCoin">
                                                {{ getCoinAnalytics(selectedCoin).totalValue | number:'1.2-2' }}
                                            </ng-container>
                                        </span>
                                        <span class="currency">USDT</span>
                                    </div>
                                    <div class="portfolio-stats row">
                                        <div class="col-6">
                                            <div class="stat-item">
                                                <span class="stat-label">Available</span>
                                                <span class="stat-value positive">
                                                    <ng-container *ngIf="!selectedCoin">
                                                        {{ getTotalAvailableValue() | number:'1.2-2' }}
                                                    </ng-container>
                                                    <ng-container *ngIf="selectedCoin">
                                                        {{ getCoinTotalAvailable() | number:'1.2-2' }}
                                                    </ng-container>
                                                    USDT
                                                </span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="stat-item">
                                                <span class="stat-label">Locked</span>
                                                <span class="stat-value neutral">
                                                    <ng-container *ngIf="!selectedCoin">
                                                        {{ getTotalLockedValue() | number:'1.2-2' }}
                                                    </ng-container>
                                                    <ng-container *ngIf="selectedCoin">
                                                        {{ getCoinTotalLocked() | number:'1.2-2' }}
                                                    </ng-container>
                                                    USDT
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Distribution Chart -->
                            <div class="col-12 col-lg-8 chart-section">
                                <div class="distribution-chart">
                                    <highcharts-chart
                                        [Highcharts]="Highcharts"
                                        [options]="chartOptions"
                                        style="display: block; min-height: 350px;">
                                    </highcharts-chart>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Exchange Cards -->
                <div class="col-12">
                    <div class="row g-4">
                        <ng-container *ngFor="let exchange of getDisplayedExchanges()">
                            <div class="col-12 col-md-6 col-lg-4">
                                <div class="exchange-card">
                                    <div class="exchange-header">
                                        <div class="exchange-title">
                                            <h3>{{ exchange.name }}</h3>
                                            <span class="percentage">
                                                ({{ getExchangePercentage(exchange) | number:'1.1-1' }}%)
                                            </span>
                                        </div>
                                        <div class="total-value">{{ exchange.value | number:'1.2-2' }} USDT</div>
                                    </div>
                                    <div class="value-details">
                                        <div class="value-distribution">
                                            <div class="distribution-item available">
                                                <div class="distribution-info">
                                                    <div class="info-label">
                                                        <span class="status">Available</span>
                                                        <span class="amount">{{ exchange.freeValue | number:'1.2-2' }} USDT</span>
                                                        <span class="percentage">{{ (exchange.freeValue / exchange.value) * 100 | number:'1.1-1' }}%</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="distribution-item locked">
                                                <div class="distribution-info">
                                                    <div class="info-label">
                                                        <span class="status">Locked</span>
                                                        <span class="amount">{{ exchange.lockedValue | number:'1.2-2' }} USDT</span>
                                                        <span class="percentage">{{ (exchange.lockedValue / exchange.value) * 100 | number:'1.1-1' }}%</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="progress-container">
                                            <div class="progress">
                                                <div class="progress-bar bg-success" 
                                                     [style.width]="((exchange.freeValue / exchange.value) * 100) + '%'">
                                                </div>
                                                <div class="progress-bar bg-warning" 
                                                     [style.width]="((exchange.lockedValue / exchange.value) * 100) + '%'">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </ng-container>
                    </div>
                </div>

                <!-- Analytics Table Section -->
                <div class="analytics-table-section mt-4">
                    <div class="container-fluid px-0">
                        <div class="row">
                            <div class="col-12">
                                <div class="table-container bg-white rounded-3 shadow-sm p-4">
                                    <!-- Table Header with Filters -->
                                    <div class="row align-items-center mb-4">
                                        <div class="col-12 mb-3">
                                            <h3 class="mb-0 fw-bold">All Coins Overview</h3>
                                        </div>
                                        <div class="col-12 col-lg-8">
                                            <div class="row align-items-center">
                                                <div class="col-12 mb-3">
                                                    <div class="exchange-filters">
                                                        <mat-button-toggle-group [(ngModel)]="selectedExchangeFilter" (change)="filterTableByExchange()" class="w-100">
                                                            <mat-button-toggle value="all">All</mat-button-toggle>
                                                            <mat-button-toggle value="Binance">Binance</mat-button-toggle>
                                                            <mat-button-toggle value="Bybit">Bybit</mat-button-toggle>
                                                            <mat-button-toggle value="Mexc">Mexc</mat-button-toggle>
                                                            <mat-button-toggle value="Kucoin">Kucoin</mat-button-toggle>
                                                            <mat-button-toggle value="Gateio">Gateio</mat-button-toggle>
                                                        </mat-button-toggle-group>
                                                    </div>
                                                </div>
                                                <div class="col-12 mt-2">
                                                    <mat-form-field appearance="outline"  floatLabel="always" class="" style="max-width: 200px;">
                                                        <mat-label>Search Coins</mat-label>
                                                        <input matInput (keyup)="applyFilter($event)" placeholder="Search coins..." #input>
                                                        <mat-icon matSuffix>search</mat-icon>
                                                    </mat-form-field>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Table Wrapper with Responsive Design -->
                                    <div class="table-responsive">
                                        <table mat-table [dataSource]="dataSource" matSort class="w-100" matSortActive="totalValue" matSortDirection="desc">
                                            <!-- Coin Column -->
                                            <ng-container matColumnDef="coin">
                                                <th mat-header-cell *matHeaderCellDef mat-sort-header class="fw-bold"> Coin </th>
                                                <td mat-cell *matCellDef="let row" class="fw-semibold"> {{row.coin}} </td>
                                            </ng-container>

                                            <!-- Exchange Column -->
                                            <ng-container matColumnDef="exchange">
                                                <th mat-header-cell *matHeaderCellDef mat-sort-header class="fw-bold"> Exchange </th>
                                                <td mat-cell *matCellDef="let row">
                                                    <span [style.background-color]="getExchangeColor(row.exchange)" 
                                                          class="exchange-chip px-2 py-1 rounded-pill text-white">
                                                        {{row.exchange}}
                                                    </span>
                                                </td>
                                            </ng-container>

                                            <!-- Current Price Column -->
                                            <ng-container matColumnDef="Current Price">
                                                <th mat-header-cell *matHeaderCellDef mat-sort-header class="fw-bold"> Current Price </th>
                                                <td mat-cell *matCellDef="let row"> 
                                                    <ng-container *ngIf="row.coin !== 'USDT' && row.coin !== 'WRX'">
                                                        <span class="text-primary">{{row.price | number:'1.2-8'}}</span>
                                                    </ng-container>
                                                    <ng-container *ngIf="row.coin === 'USDT' || row.coin === 'WRX'">
                                                        <span class="text-muted">-</span>
                                                    </ng-container>
                                                </td>
                                            </ng-container>

                                            <!-- Total Value Column -->
                                            <ng-container matColumnDef="totalValue">
                                                <th mat-header-cell *matHeaderCellDef mat-sort-header class="fw-bold"> Total Value </th>
                                                <td mat-cell *matCellDef="let row" class="fw-semibold text-success"> 
                                                    {{row.totalValue | number:'1.2-2'}} USDT 
                                                </td>
                                            </ng-container>

                                            <!-- Total Quantity Column -->
                                            <ng-container matColumnDef="totalQuantity">
                                                <th mat-header-cell *matHeaderCellDef mat-sort-header class="fw-bold"> Total Quantity </th>
                                                <td mat-cell *matCellDef="let row" class="text-dark"> 
                                                    {{row.totalQuantity | number:'1.2-8'}} 
                                                </td>
                                            </ng-container>

                                            <!-- Available Value Column -->
                                            <ng-container matColumnDef="available">
                                                <th mat-header-cell *matHeaderCellDef mat-sort-header class="fw-bold"> Available Value </th>
                                                <td mat-cell *matCellDef="let row" class="text-success"> 
                                                    {{row.available | number:'1.2-2'}} USDT 
                                                </td>
                                            </ng-container>

                                            <!-- Available Quantity Column -->
                                            <ng-container matColumnDef="availableQuantity">
                                                <th mat-header-cell *matHeaderCellDef mat-sort-header class="fw-bold"> Available Quantity </th>
                                                <td mat-cell *matCellDef="let row" class="text-success"> 
                                                    {{row.availableQuantity | number:'1.2-8'}} 
                                                </td>
                                            </ng-container>

                                            <!-- Locked Value Column -->
                                            <ng-container matColumnDef="locked">
                                                <th mat-header-cell *matHeaderCellDef mat-sort-header class="fw-bold"> Locked Value </th>
                                                <td mat-cell *matCellDef="let row" class="text-warning"> 
                                                    {{row.locked | number:'1.2-2'}} USDT 
                                                </td>
                                            </ng-container>

                                            <!-- Locked Quantity Column -->
                                            <ng-container matColumnDef="lockedQuantity">
                                                <th mat-header-cell *matHeaderCellDef mat-sort-header class="fw-bold"> Locked Quantity </th>
                                                <td mat-cell *matCellDef="let row" class="text-warning"> 
                                                    {{row.lockedQuantity | number:'1.2-8'}} 
                                                </td>
                                            </ng-container>

                                            <tr mat-header-row *matHeaderRowDef="displayedColumns" class="bg-light"></tr>
                                            <tr mat-row *matRowDef="let row; columns: displayedColumns;" 
                                                class="hover-row"></tr>

                                            <!-- Row shown when there is no matching data. -->
                                            <tr class="mat-row" *matNoDataRow>
                                                <td class="mat-cell text-center py-4" colspan="9">
                                                    <div class="d-flex flex-column align-items-center">
                                                        <mat-icon class="text-muted mb-2">search_off</mat-icon>
                                                        <span class="text-muted">No data matching the filter "{{input.value}}"</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>

                                    <!-- Paginator -->
                                    <mat-paginator [pageSizeOptions]="[5, 10, 25, 50, 100]"
                                                 [pageSize]="5"
                                                 aria-label="Select page of coins"
                                                 class="mt-3"
                                                 showFirstLastButtons>
                                    </mat-paginator>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</ng-container>



