<ng-container *ngIf="!IsExchangeDataLoaded">
<div class="loader" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 88vh;">
  <mat-spinner diameter="40"></mat-spinner>
  <span class="loading-text">Loading...</span>
</div>
  </ng-container>


<ng-container *ngIf="IsExchangeDataLoaded">

<div class="top-controls">
  <mat-form-field appearance="outline" floatLabel="always" class="search-field">
    <mat-label>Search Coin</mat-label>
    <input type="text"
           matInput
           [(ngModel)]="searchCoin"
           (ngModelChange)="onSearchChange()"
           [matAutocomplete]="auto"
           [disabled]="!IsExchangeDataLoaded"
           placeholder="BTC, ETH ...">
    <button class="clear-btn" 
            *ngIf="searchCoin" 
            matSuffix 
            mat-icon-button 
            aria-label="Clear" 
            (click)="searchCoin = ''; resetToDefault()">
      <mat-icon>close</mat-icon>
    </button>
    <mat-autocomplete #auto="matAutocomplete" (optionSelected)="onCoinSelected($event)">
      <mat-option *ngFor="let option of filteredOptions" [value]="option.coinName">
        <div class="coin-option">
          <span class="coin-name">{{option.coinName}}</span>
          <span class="exchange-tag">{{option.exchange}}</span>
        </div>
      </mat-option>
    </mat-autocomplete>
  </mat-form-field>

  <mat-form-field appearance="outline" class="exchange-select">
    <mat-label>Select Exchanges</mat-label>
    <mat-select [(ngModel)]="selectedExchanges" multiple (selectionChange)="onExchangeSelectionChange()">
      <mat-option [value]="'ALL'" (click)="toggleAllExchanges()" [disabled]="allSelected">ALL</mat-option>
      <mat-divider></mat-divider>
      <mat-option *ngFor="let exchange of exchangeNames" [value]="exchange">
        {{exchange}}
      </mat-option>
    </mat-select>
  </mat-form-field>

  <mat-slide-toggle 
    class="options-toggle"
    [(ngModel)]="show_options"
    *ngIf="IsExchangeDataLoaded">
    Options
  </mat-slide-toggle>
</div>

<!-- Global filter section -->
<div class="options-container" *ngIf="show_options">

  <!-- Sorting Section -->
  <div class="sort-container">
    <span class="section-label">Sort By:</span>
    <div class="sort-buttons">
      <button class="btn" 
        [ngStyle]="{
          'background-color': sortBy === 'name-asc' ? '#f0f0f0' : 'transparent',
          'color': sortBy === 'name-asc' ? '#1976d2' : 'rgba(0, 0, 0, 0.87)',
          'font-weight': sortBy === 'name-asc' ? '500' : 'normal'
        }"
        (click)="setSorting('name-asc')">
        Name (A-Z)
      </button>
      <button class="btn"
        [ngStyle]="{
          'background-color': sortBy === 'name-desc' ? '#f0f0f0' : 'transparent',
          'color': sortBy === 'name-desc' ? '#1976d2' : 'rgba(0, 0, 0, 0.87)',
          'font-weight': sortBy === 'name-desc' ? '500' : 'normal'
        }"
        (click)="setSorting('name-desc')">
        Name (Z-A)
      </button>
      <button class="btn"
        [ngStyle]="{
          'background-color': sortBy === 'value-asc' ? '#f0f0f0' : 'transparent',
          'color': sortBy === 'value-asc' ? '#1976d2' : 'rgba(0, 0, 0, 0.87)',
          'font-weight': sortBy === 'value-asc' ? '500' : 'normal'
        }"
        (click)="setSorting('value-asc')">
        Value (Min-Max)
      </button>
      <button class="btn"
        [ngStyle]="{
          'background-color': sortBy === 'value-desc' ? '#f0f0f0' : 'transparent',
          'color': sortBy === 'value-desc' ? '#1976d2' : 'rgba(0, 0, 0, 0.87)',
          'font-weight': sortBy === 'value-desc' ? '500' : 'normal'
        }"
        (click)="setSorting('value-desc')">
        Value (Max-Min)
      </button>
      <button class="btn"
        [ngStyle]="{
          'background-color': sortBy === 'recent-trade' ? '#f0f0f0' : 'transparent',
          'color': sortBy === 'recent-trade' ? '#1976d2' : 'rgba(0, 0, 0, 0.87)',
          'font-weight': sortBy === 'recent-trade' ? '500' : 'normal'
        }"
        (click)="setSorting('recent-trade')">
        Recent Traded
      </button>
      <button class="btn"
        [ngStyle]="{
          'background-color': sortBy === 'oldest-trade' ? '#f0f0f0' : 'transparent',
          'color': sortBy === 'oldest-trade' ? '#1976d2' : 'rgba(0, 0, 0, 0.87)',
          'font-weight': sortBy === 'oldest-trade' ? '500' : 'normal'
        }"
        (click)="setSorting('oldest-trade')">
        Oldest Traded
      </button>
    </div>
  </div>

  <!-- Filter Section -->
  <div class="filter-container">
    <span class="section-label">Filter By:</span>
    <div class="filter-buttons">
      <button class="btn" 
        [ngStyle]="{
          'background-color': selectedFilter === 1 ? '#f0f0f0' : 'transparent',
          'color': selectedFilter === 1 ? '#1976d2' : 'rgba(0, 0, 0, 0.87)',
          'font-weight': selectedFilter === 1 ? '500' : 'normal'
        }"
        (click)="setGlobalFilter(1)">
        ALL
      </button>
      <button class="btn" 
        [ngStyle]="{
          'background-color': selectedFilter === 2 ? '#f0f0f0' : 'transparent',
          'color': selectedFilter === 2 ? '#1976d2' : 'rgba(0, 0, 0, 0.87)',
          'font-weight': selectedFilter === 2 ? '500' : 'normal'
        }"
        (click)="setGlobalFilter(2)">
        HOLDINGS
      </button>
      <button class="btn"
        [ngStyle]="{
          'background-color': selectedFilter === 3 ? '#f0f0f0' : 'transparent',
          'color': selectedFilter === 3 ? '#1976d2' : 'rgba(0, 0, 0, 0.87)',
          'font-weight': selectedFilter === 3 ? '500' : 'normal'
        }"
        (click)="setGlobalFilter(3)">
        SOLD
      </button>
    </div>
  </div>
    <!-- Reset Button -->
    <div class="reset-container">
      <button class="btn btn-danger" 
              (click)="resetToDefault()" 
              [disabled]="isAtDefaultSettings()"
              [ngStyle]="{
                'opacity': isAtDefaultSettings() ? '0.5' : '1',
                'cursor': isAtDefaultSettings() ? 'not-allowed' : 'pointer'
              }">
        <i class="bi bi-arrow-counterclockwise"></i>
        Reset to Default
      </button>
    </div>
  
</div>


<div class="coins-grid">
  <div class="coin-card" *ngFor="let coinKey of getPaginatedCoins()">
    <div class="modern-card" [ngClass]="filteredExchangeData()[coinKey].exchange.toLowerCase()">
      <div class="card-background"></div>
      
      <div class="card-header">
        <div class="coin-info">
          <div class="coin-title">
            <span class="coin-name" (click)="gotoPortfolio(filteredExchangeData()[coinKey].exchange)">
              {{ filteredExchangeData()[coinKey].coinName }}
            </span>
            <div class="coin-badge">
              <mat-icon class="coin-icon">currency_bitcoin</mat-icon>
            </div>
          </div>
          <div class="status-container">
            <div class="exchange-tag">
              <mat-icon class="exchange-icon">account_balance</mat-icon>
              {{ filteredExchangeData()[coinKey].exchange }}
            </div>
            <div class="status-tag" 
                 [class.holdings]="filteredExchangeData()[coinKey].currentValue > 0.1"
                 [class.sold]="filteredExchangeData()[coinKey].currentValue <= 0.1">
              {{ filteredExchangeData()[coinKey].currentValue > 0.1 ? 'HOLDINGS' : 'SOLD' }}
            </div>
          </div>
        </div>
      </div>

      <div class="card-content">
        <div class="stat-container">
          <div class="stat-item price-stat">
            <div class="stat-label">
              <mat-icon class="stat-icon">price_change</mat-icon>
              <span>Average Price</span>
            </div>
            <div class="stat-value" [class.positive]="filteredExchangeData()[coinKey].averageBuyPrice > 0">
              <div class="value-container">
                <span class="value-number">
                  {{ filteredExchangeData()[coinKey].averageBuyPrice | number:'1.0-8'}}
                </span>
                <small class="currency">USDT</small>
              </div>
              <mat-icon class="trend-icon">trending_up</mat-icon>
            </div>
          </div>

          <div class="stat-divider"></div>

          <div class="stat-item quantity-stat">
            <div class="stat-label">
              <mat-icon class="stat-icon">account_balance_wallet</mat-icon>
              <span>Holdings</span>
            </div>
            <div class="stat-value" 
                 [class.positive]="filteredExchangeData()[coinKey].remainingQuantity > 0"
                 [class.negative]="filteredExchangeData()[coinKey].remainingQuantity < 0">
              <div class="value-container">
                <span class="value-number">
                  {{ filteredExchangeData()[coinKey].remainingQuantity | number:'1.0-8'}}
                </span>
                <small class="currency">{{ filteredExchangeData()[coinKey].coinName }}</small>
              </div>
              <mat-icon class="trend-icon">
                {{ filteredExchangeData()[coinKey].remainingQuantity > 0 ? 'arrow_upward' : 'arrow_downward' }}
              </mat-icon>
            </div>
          </div>

          <div class="stat-divider"></div>

          <div class="stat-item value-stat">
            <div class="stat-label">
              <mat-icon class="stat-icon">monetization_on</mat-icon>
              <span>Current Value</span>
            </div>
            <div class="stat-value" 
                 [class.positive]="filteredExchangeData()[coinKey].remainingQuantity > 0"
                 [class.negative]="filteredExchangeData()[coinKey].remainingQuantity < 0">
              <div class="value-container">
                <span class="value-number">
                  {{ (filteredExchangeData()[coinKey].averageBuyPrice * 
                      filteredExchangeData()[coinKey].remainingQuantity) | number:'1.2-2' }}
                </span>
                <small class="currency">USDT</small>
              </div>
              <mat-icon class="trend-icon">
                {{ filteredExchangeData()[coinKey].remainingQuantity > 0 ? 'trending_up' : 'trending_down' }}
              </mat-icon>
            </div>
          </div>

          <div class="stat-divider"></div>

          <div class="trade-counts">
            <div class="trade-count buy text-success">
              <i class="bi bi-arrow-up-circle-fill"></i>
              <span>{{ filteredExchangeData()[coinKey].buyTrades }} Buys</span>
            </div>
            <div class="trade-count sell text-danger">
              <i class="bi bi-arrow-down-circle-fill"></i>
              <span>{{ filteredExchangeData()[coinKey].sellTrades }} Sells</span>
            </div>
          </div>
        </div>
      </div>

      <div class="card-footer">
        <div class="footer-buttons">
          <button mat-button class="view-details" (click)="gotoPortfolio(filteredExchangeData()[coinKey].exchange)">
            <span>Portfolio</span>
            <mat-icon>trending_up</mat-icon>
          </button>
          <button mat-button class="show-details" 
                  (click)="openDetailsModal(filteredExchangeData()[coinKey].exchange, filteredExchangeData()[coinKey].coinName)">
            <span>Details</span>
            <mat-icon>info</mat-icon>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<mat-paginator
  [length]="getTotalCoins()"
  [pageSize]="pageSize"
  class="mt-4"
  [pageSizeOptions]="[5, 10, 15, 30, 60, 100]"
  (page)="onPageChange($event)"
  aria-label="Select page">
</mat-paginator>

</ng-container>